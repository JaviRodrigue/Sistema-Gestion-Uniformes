using Microsoft.Data.Sqlite;
using Microsoft.EntityFrameworkCore;
using VentasApp.Infrastructure.Persistencia.Contexto;

namespace VentasApp.Infrastructure.Persistencia.Migrations;

/// <summary>
/// Helper para aplicar migraciones manuales a la base de datos sin usar EF Migrations.
/// Útil para cambios menores en desarrollo con SQLite.
/// </summary>
public static class DatabaseMigrationHelper
{
    /// <summary>
    /// Aplica todas las migraciones pendientes al esquema de la base de datos.
    /// </summary>
    public static async Task AplicarMigracionesAsync(DatabaseContext context)
    {
        await AgregarColumnaVerificadoAPagoSiNoExiste(context);
        await AgregarColumnaEntregadoADetalleVentaSiNoExiste(context);
    }

    private static async Task AgregarColumnaVerificadoAPagoSiNoExiste(DatabaseContext context)
    {
        var connection = context.Database.GetDbConnection();
        var wasClosedInitially = connection.State == System.Data.ConnectionState.Closed;

        try
        {
            if (wasClosedInitially)
            {
                await connection.OpenAsync();
            }

            // Verificar si la columna existe
            using var cmd = connection.CreateCommand();
            cmd.CommandText = "PRAGMA table_info(Pago);";
            
            var columnaExiste = false;
            using (var reader = await cmd.ExecuteReaderAsync())
            {
                while (await reader.ReadAsync())
                {
                    var columnName = reader.GetString(1); // name es la segunda columna en table_info
                    if (columnName.Equals("verificado", StringComparison.OrdinalIgnoreCase))
                    {
                        columnaExiste = true;
                        break;
                    }
                }
            }

            // Si no existe, agregarla
            if (!columnaExiste)
            {
                using var alterCmd = connection.CreateCommand();
                alterCmd.CommandText = "ALTER TABLE Pago ADD COLUMN verificado INTEGER NOT NULL DEFAULT 0;";
                await alterCmd.ExecuteNonQueryAsync();
                
                System.Diagnostics.Debug.WriteLine("✓ Columna 'verificado' agregada a la tabla Pago");
            }
        }
        finally
        {
            if (wasClosedInitially && connection.State == System.Data.ConnectionState.Open)
            {
                await connection.CloseAsync();
            }
        }
    }
}
