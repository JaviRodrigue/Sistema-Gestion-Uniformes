using System.Linq;
using System.Threading.Tasks;
using VentasApp.Application.DTOs.ItemVendible;
using VentasApp.Application.DTOs.Productos;
using VentasApp.Application.DTOs.Venta;
using VentasApp.Application.Interfaces.Repositorios;
using VentasApp.Domain.Modelo.Venta;

namespace VentasApp.Application.CasoDeUso.Venta;

public class ObtenerVentaUseCase
{
    private readonly IVentaRepository _ventaRepository;
    private readonly IPagoRepository _pagoRepository;
    private readonly IItemVendibleRepository _itemRepository;
    private readonly IClienteRepository _clienteRepository;

    public ObtenerVentaUseCase(IVentaRepository ventaRepository, IPagoRepository pagoRepository, IItemVendibleRepository itemRepository, IClienteRepository clienteRepository)
    {
        _ventaRepository = ventaRepository;
        _pagoRepository = pagoRepository;
        _itemRepository = itemRepository;
        _clienteRepository = clienteRepository;
    }

    public async Task<VentaDetalleDto?> EjecutarAsync(int id)
    {
        var v = await _ventaRepository.ObtenerPorId(id);
        if (v == null) return null;

        var clienteVenta = await _clienteRepository.ObtenerClientePorVenta(v.Id);

        var dto = new VentaDetalleDto
        {
            Id = v.Id,
            Codigo = $"V-{v.Id:0000}",
            Cliente = clienteVenta?.Nombre ?? string.Empty,
            IdCliente = clienteVenta?.Id ?? 0,
            Total = v.MontoTotal,
            Restante = v.SaldoPendiente,
            Items = v.Detalles.Select(d => new VentaItemDto
            {
                IdDetalle = d.Id,
                IdItemVendible = d.IdItemVendible,
                Descripcion = $"Item {d.IdItemVendible}",
                Cantidad = d.Cantidad,
                PrecioUnitario = d.PrecioUnitario
            }).ToList()
        };

        // Cargar descripciones reales de ItemVendible si existen
        foreach (var item in dto.Items)
        {
            if (item.IdItemVendible > 0)
            {
                var iv = await _itemRepository.ObtenerItem(item.IdItemVendible);
                if (iv != null)
                {
                    item.Descripcion = iv.Nombre ?? iv.CodigoBarra ?? $"Item {iv.Id}";
                }
            }
        }

        // Cargar pagos asociados
        var pagos = await _pagoRepository.ObtenerPorVenta(v.Id);
        dto.Pagos = pagos.Select(p => new VentasApp.Application.DTOs.Pago.PagoDto
        {
            Id = p.Id,
            IdVenta = p.IdVenta,
            FechaPago = p.FechaPago,
            Total = p.Total,
            Verificado = p.Verificado,
            Metodos = p.Metodos.Select(m => new VentasApp.Application.DTOs.Pago.PagoMetodoDetalleDto
            {
                IdMedioPago = m.IdMedioPago,
                MedioPago = m.MedioPago?.Nombre ?? "",
                Monto = m.Monto
            }).ToList()
        }).ToList();

        return dto;
    }
}
