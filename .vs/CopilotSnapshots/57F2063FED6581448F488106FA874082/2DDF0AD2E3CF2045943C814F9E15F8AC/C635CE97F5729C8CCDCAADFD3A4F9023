using CommunityToolkit.Mvvm.ComponentModel;
using CommunityToolkit.Mvvm.Input;
using System.Collections.ObjectModel;
using VentasApp.Application.CasoDeUso.Venta;
using VentasApp.Application.DTOs.Venta;
using VentasApp.Desktop.ViewModels.DTOs;
using VentasApp.Desktop.Views.Ventas;

namespace VentasApp.Desktop.ViewModels.Ventas;

public partial class VentaViewModel : ObservableObject
{
    private readonly ListarVentasUseCase _listar;
    private readonly ObtenerVentaUseCase _obtener;
    private readonly CrearVentaUseCase _crear;
    private readonly AnularVentaUseCase _anular;
    private readonly VentasApp.Application.CasoDeUso.DetalleVenta.GuardarDetalleVentaUseCase _guardarDetalle;

    [ObservableProperty]
    private ObservableCollection<VentaCardDto> _ventas = new();

    public VentaViewModel(
        ListarVentasUseCase listar,
        ObtenerVentaUseCase obtener,
        CrearVentaUseCase crear,
        AnularVentaUseCase anular,
        VentasApp.Application.CasoDeUso.DetalleVenta.GuardarDetalleVentaUseCase guardarDetalle)
    {
        _listar = listar;
        _obtener = obtener;
        _crear = crear;
        _anular = anular;
        _guardarDetalle = guardarDetalle;

        _ = CargarAsync();
    }

    private async Task CargarAsync()
    {
        var lista = await _listar.EjecutarAsync();

        Ventas = new ObservableCollection<VentaCardDto>(
            lista.Select(v => new VentaCardDto
            {
                Id = v.Id,
                Codigo = v.Codigo,
                Fecha = v.Fecha,
                EstadoVenta = v.EstadoVenta,
                EstadoPago = v.EstadoPago,
                Total = v.Total,
                Restante = v.Restante
             }));
    }

    [RelayCommand]
    private async Task VerDetalle(VentaCardDto card)
    {
        var detalle = await _obtener.EjecutarAsync(card.Id);
        if (detalle is null) return;

        var uiDetalle = MapDetalle(detalle);
        uiDetalle.Id = detalle.Id;
        var win = new DetalleVentaWindow(uiDetalle, _guardarDetalle);
        win.ShowDialog();
    }

    private static VentasApp.Desktop.ViewModels.DTOs.VentaDetalleDto MapDetalle(VentasApp.Application.DTOs.Venta.VentaDetalleDto src)
    {
        return new VentasApp.Desktop.ViewModels.DTOs.VentaDetalleDto
        {
            Codigo = src.Codigo,
            Cliente = src.Cliente,
            // FechaEstimada no existe en el DTO de aplicación
            Items = new ObservableCollection<VentasApp.Desktop.ViewModels.DTOs.VentaItemDto>(
                src.Items.Select(i => new VentasApp.Desktop.ViewModels.DTOs.VentaItemDto
                {
                    IdDetalle = i.IdDetalle,
                    Producto = i.Descripcion,
                    PrecioUnitario = i.PrecioUnitario,
                    Cantidad = i.Cantidad
                })),
            Pagos = new ObservableCollection<VentasApp.Desktop.ViewModels.DTOs.PagoDto>(
                src.Pagos.SelectMany(p => p.Metodos.Select(m => new VentasApp.Desktop.ViewModels.DTOs.PagoDto
                {
                    Fecha = p.FechaPago,
                    Monto = m.Monto,
                    MedioPago = m.MedioPago
                })))
        };
    }

    [RelayCommand]
    private async Task AgregarVenta()
    {
        var id = await _crear.EjecutarAsync(new CrearVentaDto());

        await CargarAsync();
    }

    [RelayCommand]
    private async Task EliminarVenta(VentaCardDto card)
    {
        await _anular.EjecutarAsync(card.Id);
        await CargarAsync();
    }
}
